language: cpp
cache: apt
compiler:
  - gcc

before_install:
  - sudo apt-add-repository ppa:dhart/ppa

install:
  - wget http://ftp.de.debian.org/debian/pool/main/l/lcov/lcov_1.11.orig.tar.gz
  - tar xf lcov_1.11.orig.tar.gz
  - sudo make -C lcov-1.11/ install
  - gem install coveralls-lcov
  - if [ "$CXX" = "g++" ]; then export CXX="g++-4.8" CC="gcc-4.8"; sudo update-alternatives --install /usr/bin/gcov gcov /usr/bin/gcov-4.8 90; fi

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - gcc-4.8
      - g++-4.8
      - valgrind
      - cxxtest

script: 
  - ( mkdir build && cd build && cmake -DWIGWAG_VALGRIND=TRUE .. && make )
  - valgrind --suppressions=valgrind.sup --tool=helgrind --gen-suppressions=all --error-exitcode=1 ./build/bin/wigwag_test
  - rm -rf ./build
  - ( mkdir build && cd build && cmake -DWIGWAG_COVERAGE=TRUE .. && make )
  - ./build/bin/wigwag_test

after_success:
  - lcov --directory . --capture --output-file coverage.info
  - lcov --remove coverage.info 'test/*' '/usr/*' --output-file coverage.info
  - lcov --list coverage.info
  - coveralls-lcov --repo-token ${COVERALLS_TOKEN} coverage.info
